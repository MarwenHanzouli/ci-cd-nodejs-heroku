name: Node.js CI
on:
  push:
    branches:
      - master
jobs:
    build:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                node-version: [8.x, 10.x, 12.x]
            
        steps:
            - name: Checkout source code
              uses: actions/checkout@v2
            
            - name: Use Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v1
              with:
                node-version: ${{ matrix.node-version }}
            - name: Cache Node.js modules
              uses: actions/cache@v2
              with:
                # npm cache files are stored in `~/.npm` on Linux/macOS
                path: ~/.npm 
                key: ${{ runner.OS }}-node-${{ hashFiles('**/package-lock.json') }}
                restore-keys: |
                    ${{ runner.OS }}-node-
                    ${{ runner.OS }}-
            - name: Install dependencies
              run: npm install
            - name: Lint
              run: npm run lint
            - name: Unit tests
              run: npm run test
            - name: Build app if present
              run: npm run build --if-present
            - name: Inject slug/short variables
              uses: rlespinasse/github-slug-action@v2.x
            - name: Upload artifact
              uses: actions/upload-artifact@v2
              with:
                name: ci-cd-nodejs-${{ env.GITHUB_REF_SLUG }}-${{ github.run_id }}-${{ github.run_number }}
                path: ./

    deploy:
        needs: build
        runs-on: ubuntu-latest

        steps:
            - name: Inject slug/short variables
              uses: rlespinasse/github-slug-action@v2.x
            - name: Download artifact
              uses: actions/download-artifact@v2
              with:
                name: ci-cd-nodejs-${{ env.GITHUB_REF_SLUG }}-${{ github.run_id }}-${{ github.run_number }}
                path: './build'
            - name: Deploy to Heroku
              uses: akhileshns/heroku-deploy@v3.6.8
              with:
                heroku_api_key: ${{secrets.HEROKU_API_KEY}}
                heroku_app_name: ci-cd-nodejs #Must be unique in Heroku
                heroku_email: marwenhanzouli@gmail.com
                publish-dir: './build'
                production-branch: master
                deploy-message: "Deploy from GitHub Actions"